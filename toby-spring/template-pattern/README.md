# 템플릿

## 개방 폐쇄 원칙(OCP)

확장에는 자유롭게 열려 있고 변경에는 굳게 닫혀 있다는 객체지향 설계의 핵심 원칙이다.

코드를 보면 어떤 부분은 수정하면서 다양하게 확장하려고 하고, 어떤 부분은 고정되어 변하지 않으려고 한다. 이때 각기 특성이 다른 부분을 구분하고 독립적으로 변경될 수 있게 하는 것이다.



## 템플릿

이 중에서 변경이 거의 일어나지 않고 일정한 패턴으로 유지되는 부분을 변경되는 부분에서 독립시키는 방법이다.

## 리소스 반환과 close()

`Connection`이나 `PreparedStatement`의 `close()`는 리소스를 반환하는 메소드다. 이 둘은 보통 pool 방식으로 운영된다. 미리 정해진 풀 안에 제한된 수의 리소스(Connection, Statement)를 만들어두고 필요할떄 할당하고 반환하면 다시 풀에 넣는다.

서버 환경에서는 요청이 매우 많아 매번 새로운 리소스를 생성하는 대신 풀에 미리 만들어둔 리소스를 돌려가며 사용하는 것이 훨씬 유리하다. 대신 사용한 리소스는 빠르게 반환해야 한다.

그렇지 않으면 풀에 있는 리소스가 고갈되고 문제가 발생한다. 이를 방지하기 위해 `close()` 메소드는 리소스를 풀로 다시 돌려주는 역할을 한다.

## UserDAO의 템플릿 적용

UserDAO는 DB 커넥션에 대한 예외 상황을 처리하지 않았다. DB 커넥션은 반드시 예외 처리가 필요하다. 중간에 어떤 예외에 발생해도 사용한 리소스를 반드시 반환해야 하기 때문이다.

```java
public class UserDAO {
    public void deleteAll() throws SQLException {
        Connection c = dataSource.getConnection();

        // 여기서 예외가 발생하면 바로 메소드 실행이 중단된다.
        PreparedStatement ps = c.preparedStatement("delte form users");
        ps.executeUpdate();
    
        // 메소드 실행이 중지되면 리소스를 반환하지 못한다.
        ps.close();
        c.close();
    }
}
```

일반적으로 서버는 제한된 개수의 DB 커넥션을 만들고 재사용 가능한 풀로 관리한다. 매번 `getConnection()`으로 가져온 커넥션을 `close()`로 명시해서돌려줘야 다음 커넥션 요청 시 재사용할 수 있다.

하지만 오류가 나서 반환되지 못한 `Connection`이 계속 쌓이면 어느 순간 커넥션 풀에 여유가 없어지고 리소스가 모자라 심각한 오류와 함께 서버가 중단될 수 있다.

그래서 JDBC는 어떤 상황에서도 가져온 리소스를 반환하도록 try/catch/finally 사용을 권장한다.